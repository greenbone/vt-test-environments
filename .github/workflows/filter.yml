name: Filter and trigger builds on changes
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.filter.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Calculate Build Matrix
        id: filter
        run: |
          # ---------------------------------------------------------
          # 1. Determine Git Diff Range
          # ---------------------------------------------------------
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="origin/${{ github.base_ref }}"
          else
            BASE_REF="${{ github.event.before }}"
          fi
          echo "Checking changes against base ref: $BASE_REF"

          # ---------------------------------------------------------
          # 2. Identify Changed Directories
          # ---------------------------------------------------------
          FILES=$(git diff --name-only $BASE_REF ${{ github.sha }})
          
          # Extract directories, sort, and remove duplicates
          CHANGED_DIRS=$(echo "$FILES" | xargs -r dirname | sort | uniq)
          
          echo "::group::Changed Directories"
          echo "$CHANGED_DIRS"
          echo "::endgroup::"

          # ---------------------------------------------------------
          # 3. Identify Matrix Changes
          # ---------------------------------------------------------
          git show "$BASE_REF:matrix.json" > old_matrix.json
          
          # Find items that are new in matrix.json (New - Old)
          jq -s '.[0] - .[1]' matrix.json old_matrix.json > by_matrix.json
          
          echo "::group::Matrix Changes (New Entries)"
          jq . by_matrix.json
          echo "::endgroup::"

          # ---------------------------------------------------------
          # 4. Generate Filtered Matrix
          # ---------------------------------------------------------
          # Filter by directories
          jq -c --arg changed_dirs "$CHANGED_DIRS" '[.[] | select(.CONTEXT | inside($changed_dirs))]' matrix.json > by_dirs.json
          
          # Combine results from changed dirs and changed matrix entries and remove duplicates
          FILTERED=$(jq -s '.[0] + .[1] | unique' by_dirs.json by_matrix.json)
          
          echo "::group::Filtered Matrix"
          echo "$FILTERED" | jq .
          echo "::endgroup::"
          
          # Generate Job Summary
          echo "### Build Plan" >> $GITHUB_STEP_SUMMARY
          if [ "$FILTERED" == "[]" ]; then
            echo "No changes detected. Skipping builds." >> $GITHUB_STEP_SUMMARY
          else
            echo "| Context | Base Image | Tag | Export Tag | Updated |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "$FILTERED" | jq -r '.[] | "| `\(.CONTEXT)` | `\(.BASEIMAGE // "-")` | `\(.TAG)` | `\(.EXPORT_TAG // "-")` | `\(.UPDATED // "-")` |"' >> $GITHUB_STEP_SUMMARY
          fi

          # Set the filtered matrix as an output for the next job
          echo "matrix=$FILTERED" >> $GITHUB_OUTPUT

  build:
    needs: filter
    if: needs.filter.outputs.matrix != '[]'
    uses: ./.github/workflows/build.yml
    with:
      matrix: ${{ needs.filter.outputs.matrix }}
      publish: ${{ github.event_name == 'push' }}
