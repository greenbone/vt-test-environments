name: Filter and trigger builds on changes
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.filter.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Determine Base Reference
        id: base_ref
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="origin/${{ github.base_ref }}"
          else
            BASE_REF="${{ github.event.before }}"
          fi
          echo "Checking changes against base ref: $BASE_REF"

          echo "base_ref=$BASE_REF" >> "$GITHUB_OUTPUT"

      - name: Identify Changed Directories
        id: files
        run: |
          BASE_REF="${{ steps.base_ref.outputs.base_ref }}"

          # Extract directories from changed files to later compare with the matrix.json entries.
          # Sort and remove duplicates to ensure each directory is listed only once.
          git diff --name-only $BASE_REF ${{ github.sha }} | xargs -r dirname | sort | uniq > changed_dirs.txt
          
          echo "::group::Changed Directories"
          cat changed_dirs.txt
          echo "::endgroup::"

      - name: Identify Matrix Changes
        id: matrix_changes
        run: |
          BASE_REF="${{ steps.base_ref.outputs.base_ref }}"

          git show "$BASE_REF:matrix.json" > old_matrix.json
          
          # Find items that are new in matrix.json (New - Old)
          # Deleted items are ignored by the subtraction.
          # If an item is present in 'old' but not in 'new', it is excluded from the output.
          jq -s '.[0] - .[1]' matrix.json old_matrix.json > by_matrix.json
          
          echo "::group::Matrix Changes (New Entries)"
          jq . by_matrix.json
          echo "::endgroup::"


      - name: Generate Filtered Matrix
        id: filter
        run: |
          # Filter 'matrix.json' to keep ALL items whose CONTEXT matches one of the changed directories.
          # If a directory changed, every build configuration (matrix entry) associated with that directory is kept.
          jq -c --rawfile changed_dirs changed_dirs.txt '[.[] | select(.CONTEXT | inside($changed_dirs))]' matrix.json > by_dirs.json
          
          # Merge the list from file changes (by_dirs.json) with added entries to matrix.json (by_matrix.json).
          # '| unique' : Removes duplicates in case an item was selected by both triggers.
          FILTERED=$(jq -c -s '.[0] + .[1] | unique' by_dirs.json by_matrix.json)
          
          echo "::group::Filtered Matrix"
          echo "$FILTERED" | jq .
          echo "::endgroup::"
          
          echo "matrix=$FILTERED" >> $GITHUB_OUTPUT

      - name: Generate Job Summary
        env:
          FILTERED: ${{ steps.filter.outputs.matrix }}
        run: |
          echo "### Build Plan" >> $GITHUB_STEP_SUMMARY
          if [ "$FILTERED" == "[]" ]; then
            echo "No changes detected. Skipping builds." >> $GITHUB_STEP_SUMMARY
          else
            echo "| Context | Base Image | Tag | Export Tag | Updated |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "$FILTERED" | jq -r '.[] | "| `\(.CONTEXT)` | `\(.BASEIMAGE // "-")` | `\(.TAG)` | `\(.EXPORT_TAG // "-")` | `\(.UPDATED // "-")` |"' >> $GITHUB_STEP_SUMMARY
          fi

  # What is run explanation:
  # 1. File Changes (Directory based): 
  #    If a file changes in a directory (e.g. operating_systems/almalinux), 
  #    all matrix entries (releases) pointing to that directory (CONTEXT) are selected. 
  #    This ensures that a code change triggers a rebuild for all versions of that product.
  # 2. Matrix Additions (Config based):
  #    If a new entry is added to matrix.json, only that specific new entry is selected.
  build:
    needs: filter
    if: needs.filter.outputs.matrix != '[]'
    uses: ./.github/workflows/build.yml
    with:
      matrix: ${{ needs.filter.outputs.matrix }}
      publish: ${{ github.event_name == 'push' }}
